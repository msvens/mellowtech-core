<!DOCTYPE html>
<!--
 | Generated by Apache Maven Doxia at 2015-05-02
 | Rendered using Apache Maven Fluido Skin 1.3.0
-->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="Date-Revision-yyyymmdd" content="20150502" />
    <meta http-equiv="Content-Language" content="en" />
    <title>Mellowtech Core &#x2013; Overview</title>
    <link rel="stylesheet" href="./css/apache-maven-fluido-1.3.0.min.css" />
    <link rel="stylesheet" href="./css/site.css" />
    <link rel="stylesheet" href="./css/print.css" media="print" />

      
    <script type="text/javascript" src="./js/apache-maven-fluido-1.3.0.min.js"></script>

    
            </head>
        <body class="topBarDisabled">
          
        
    
        <div class="container-fluid">
          <div id="banner">
        <div class="pull-left">
                                                  <a href="./" id="bannerLeft">
                <h2>Mellowtech Core</h2>
                </a>
                      </div>
        <div class="pull-right">  </div>
        <div class="clear"><hr/></div>
      </div>

      <div id="breadcrumbs">
        <ul class="breadcrumb">
                
                    
                  <li id="publishDate">Last Published: 2015-05-02</li>
                  <li class="divider">|</li> <li id="projectVersion">Version: 3.0-SNAPSHOT</li>
                      
                
                    
      
                            </ul>
      </div>

            
      <div class="row-fluid">
        <div id="leftColumn" class="span3">
          <div class="well sidebar-nav">
                
                    
                <ul class="nav nav-list">
                    <li class="nav-header">Overview</li>
                                
      <li>
    
                          <a href="index.html" title="introduction">
          <i class="none"></i>
        introduction</a>
            </li>
                  
      <li>
    
                          <a href="byteStorables.html" title="byte storables">
          <i class="none"></i>
        byte storables</a>
            </li>
                  
      <li>
    
                          <a href="IO.html" title="IO">
          <i class="none"></i>
        IO</a>
            </li>
                  
      <li>
    
                          <a href="sorting.html" title="sorting">
          <i class="none"></i>
        sorting</a>
            </li>
                  
      <li class="active">
    
            <a href="#"><i class="none"></i>collections</a>
          </li>
                              <li class="nav-header">Project Documentation</li>
                                                                                                    
      <li>
    
                          <a href="project-info.html" title="Project Information">
          <i class="icon-chevron-right"></i>
        Project Information</a>
                  </li>
                                                                                                        
      <li>
    
                          <a href="project-reports.html" title="Project Reports">
          <i class="icon-chevron-right"></i>
        Project Reports</a>
                  </li>
            </ul>
                
                    
                
          <hr class="divider" />

           <div id="poweredBy">
                            <div class="clear"></div>
                            <div class="clear"></div>
                            <div class="clear"></div>
                             <a href="http://maven.apache.org/" title="Built by Maven" class="poweredBy">
        <img class="builtBy" alt="Built by Maven" src="./images/logos/maven-feather.png" />
      </a>
                  </div>
          </div>
        </div>
        
                
        <div id="bodyColumn"  class="span9" >
                                  
            <h1>Overview</h1>
<p>Mellowtech Core Collections is a set of classes for disc based key-value maps. It supports both sorted and hashed maps. The hash map implementation is still rough around the edges so the sorted map is preferred.</p>
<p>Most implementation was inspired by the book File Structures (Michael Folk, Bill Zoellick). This is an excellent introduction to the underlying principles of modern databases. </p>
<p>The Collections API comes in two flavors. Firstly you can directly use the underlying disc maps (BTree and ExtendibleHashTable) and secondly you can use the <i>java.util.collections.Map</i> abstraction.</p>
<p><b>All maps are unsynchronized</b></p>
<div class="section">
<h2><a name="BTree"></a>BTree</h2>
<p>There are two main implementations of <i>org.mellowtech.core.collections.tree.BTree</i>.</p>
<p><b>BTreeImp</b> - implements a btree using two files - one to store the index and one to store the key/values. <i>BTreeImp</i> does not use any in-memory buffer and all write operations are always directly written to file. This implementation is suitable when you * don&#x2019;t have extreme requirements on speed * when you have limited memory available * when your index can grow very big (which is typically not very likely)</p>
<p><b>MemMappedBPTreeImp</b> - implements a btree using one backing file (org.mellowtech.core.io.SplitRecordFile). The index will always be kept in a memory mapped buffer. Based on configuration the Key/Value part of the BTree can also be memory mapped. The MemMappedBPTreeImp is suitable when you * know that the index will not grow beyond a certain point * when you need a fast btree</p>
<p>The simplest way of creating a BTree is to use <i>org.mellowtech.core.collections.tree.BTreeBuilder</i></p>

<div class="source">
<div class="source">
<pre>BTree bt = new BTreeBuilder().valuesInMemory(true).build(&quot;someFileName&quot;,new CBString(), new CBString())
</pre></div></div>
<p>Would create a BTree that have its values memory mapped and all other options set to its default values</p></div>
<div class="section">
<h2><a name="ExtendibleHashTable"></a>ExtendibleHashTable</h2>
<p>To be written</p></div>
<div class="section">
<h2><a name="Collections"></a>Collections</h2>
<p>If you prefer to work with normal objects (i.e. not ByteStorables) the <i>org.mellowtech.core.collections.DiscMap</i> API is for you. It extends <i>java.util.Map</i> and adds a couple of methods for closing/saving a map to disc as well as 2 entry iterators.</p>
<p>DiscMap comes with 2 concrete implementations (DiscBasedMap and DiscBasedHashMap) that use BTree and ExtendibleHashTable respectively. DiscMaps use Mappings to convert objects to and from ByteStorables so when you use the DiscMap API you need to make sure that there is a corresponding Mapping for it. mellowtech.core comes with a default set of Mappings that can be extended with user defined mappings</p>

<div class="source">
<div class="source">
<pre>BCMapping m = MappingFactory.createMapping(String.class);
DiscMap map = new DiscBasedMap(m,m,&quot;someFileName&quot;,new BTreeBuilder().valuesInMemory(true));
map.put(&quot;firstKey&quot;, &quot;firstValue&quot;);
</pre></div></div>
<p>Would create the same underlying structure as the previous example but expose it is as an ordinary map</p></div>
<div class="section">
<h2><a name="Example"></a>Example</h2>
<p>In this example we will build on the data we sorted in the <a href="sorting.html">sorting</a> section. The idea is to create a BTree that holds all unique words and the number of times the occur. Given large enough data it is a lot faster to sort it first and then insert it than continuously update a counter value of a key in a tree.</p>
<p>The first thing we need to implement is an iterator that emits CBString,CBInt pairs based on a sorted input file.</p>

<div class="source">
<div class="source">
<pre>  static class WordIter implements Iterator&lt;KeyValue&lt;CBString, CBInt&gt;&gt; {

    StorableInputStream&lt;CBString&gt; sis;
    KeyValue&lt;CBString, CBInt&gt; next = null;
    CBString nextWord = null;
    CBString prev = null;

    public WordIter(StorableInputStream&lt;CBString&gt; sis) {
      this.sis = sis;
      next = new KeyValue&lt;&gt;();
      try {
        nextWord = sis.next();
        prev = nextWord;
      } catch (IOException e) {
        throw new Error(&quot;could not read&quot;);
      }
      getNext();
    }

    private void getNext() {
      if (nextWord == null) {
        next = null;
        return;
      }
      next = new KeyValue&lt;&gt;();
      int count = 1;
      next.setKey(nextWord);
      try {
        while (true) {
          nextWord = sis.next();
          if (nextWord == null || nextWord.compareTo(next.getKey()) != 0) {
            break;
          }
          count++;
          prev = nextWord;
        }
      } catch (IOException e) {
        throw new Error(&quot;could not read&quot;);
      }
      next.setValue(new CBInt(count));
    }

    public boolean hasNext() {
      return nextWord != null;
    }

    public KeyValue&lt;CBString, CBInt&gt; next() {
      KeyValue&lt;CBString, CBInt&gt; tmp = next;
      getNext();
      return tmp;
    }

    public void remove() {
      throw new UnsupportedOperationException();
    }
  }
</pre></div></div>
<p>The iterator takes as input a sorted file of CBStrings and produce CBString,CBInt pairs. Again, observe that the iterator relies on a sorted input file.</p>
<p>Once we have our iterator in place it is simple enough to generate our tree</p>

<div class="source">
<div class="source">
<pre>BTreeBuilder builder = new BTreeBuilder();
BTree &lt;CBString, CBInt&gt; tree = builder.indexInMemory(true).build(new CBString(), new CBInt(), &quot;/some/path/to/tree&quot;);
StorableInputStream &lt;CBString&gt; sis = new StorableInputStream &lt;&gt;(new FileInputStream(&quot;/tmp/english-sorted.bs&quot;), new CBString());
WordIter iter = new WordIter(sis);
tree.createIndex(iter);
tree.close();
</pre></div></div>
<p>To make sure that everything works as expected we could for instance iterate over the tree and print the results</p>

<div class="source">
<div class="source">
<pre>BTreeBuilder builder = new BTreeBuilder();
BTree &lt;CBString, CBInt&gt; tree = builder.indexInMemory(true).build(new CBString(), new CBInt(), &quot;/some/path/to/tree&quot;);
Iterator &lt;KeyValue&lt;CBString,CBInt&gt;&gt; iter = tree.iterator();
while(iter.hasNext()){
  KeyValue &lt;CBString, CBInt&gt; kv = iter.next();
  System.out.println(kv.getKey()+&quot;: &quot;+kv.getValue());
}
</pre></div></div></div>
                  </div>
            </div>
          </div>

    <hr/>

    <footer>
            <div class="container-fluid">
              <div class="row span12">Copyright &copy;                   2015.
          All Rights Reserved.      
                    
      </div>

        
        
                </div>
    </footer>
  </body>
</html>
