<!DOCTYPE html>
<!--
 | Generated by Apache Maven Doxia at 2015-12-01
 | Rendered using Apache Maven Fluido Skin 1.3.0
-->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="Date-Revision-yyyymmdd" content="20151201" />
    <meta http-equiv="Content-Language" content="en" />
    <title>Mellowtech Core &#x2013; Overview</title>
    <link rel="stylesheet" href="./css/apache-maven-fluido-1.3.0.min.css" />
    <link rel="stylesheet" href="./css/site.css" />
    <link rel="stylesheet" href="./css/print.css" media="print" />

      
    <script type="text/javascript" src="./js/apache-maven-fluido-1.3.0.min.js"></script>

    
            </head>
        <body class="topBarDisabled">
          
        
    
        <div class="container-fluid">
          <div id="banner">
        <div class="pull-left">
                                    <a href="http://www.mellowtech.org/projects/core" id="bannerLeft">
                <h2>Mellowtech Core</h2>
                </a>
                      </div>
        <div class="pull-right">  </div>
        <div class="clear"><hr/></div>
      </div>

      <div id="breadcrumbs">
        <ul class="breadcrumb">
                
                    
                  <li id="publishDate">Last Published: 2015-12-01</li>
                  <li class="divider">|</li> <li id="projectVersion">Version: 3.0.3</li>
                      
                
                    
      
                            </ul>
      </div>

            
      <div class="row-fluid">
        <div id="leftColumn" class="span3">
          <div class="well sidebar-nav">
                
                    
                <ul class="nav nav-list">
                    <li class="nav-header">Overview</li>
                                
      <li>
    
                          <a href="index.html" title="introduction">
          <i class="none"></i>
        introduction</a>
            </li>
                  
      <li>
    
                          <a href="byteStorables.html" title="byte storables">
          <i class="none"></i>
        byte storables</a>
            </li>
                  
      <li>
    
                          <a href="IO.html" title="IO">
          <i class="none"></i>
        IO</a>
            </li>
                  
      <li class="active">
    
            <a href="#"><i class="none"></i>sorting</a>
          </li>
                  
      <li>
    
                          <a href="collections.html" title="collections">
          <i class="none"></i>
        collections</a>
            </li>
                              <li class="nav-header">Project Documentation</li>
                                                                                                    
      <li>
    
                          <a href="project-info.html" title="Project Information">
          <i class="icon-chevron-right"></i>
        Project Information</a>
                  </li>
                                                                                                        
      <li>
    
                          <a href="project-reports.html" title="Project Reports">
          <i class="icon-chevron-right"></i>
        Project Reports</a>
                  </li>
            </ul>
                
                    
                
          <hr class="divider" />

           <div id="poweredBy">
                            <div class="clear"></div>
                            <div class="clear"></div>
                            <div class="clear"></div>
                             <a href="http://maven.apache.org/" title="Built by Maven" class="poweredBy">
        <img class="builtBy" alt="Built by Maven" src="./images/logos/maven-feather.png" />
      </a>
                  </div>
          </div>
        </div>
        
                
        <div id="bodyColumn"  class="span9" >
                                  
            <h1>Overview</h1>
<p>One of the original purposes of Mellowtech Core was to offer fast disc based sorting for handling indexing of large document collections. Typically it is always faster to work with sorted data when you build your text search index. Obviously, there are other circumstances in which you want to sort larger amounts of data without being restricted by ram memory</p>
<p>Sorting comes in two different flavors: <i>ByteStorable</i> sort and <i>ByteComparable</i> sort. The difference being that the ByteComparable sort will not create any objects and instead sorts objects stored in a byte buffer/array. Typically, the <i>ByteComparable</i> version is a lot faster since it never &#x201c;unpacks&#x201d; the incoming input stream of objects.</p>
<p>The general flow of the sort can be seen below</p>
<p><br /> <img src="img/sort.png" alt="sort flow" style="height:400px" /></p>
<div class="section">
<h2><a name="Example_Usage"></a>Example Usage</h2>
<p>In the following example we will use the <i>ByteComparable</i> version (org.mellowtech.core.sort.EDiscBasedSort). For ordinary sort (org.mellowtech.core.sort.DiscBasedSort) the pattern is exactly the same</p>
<div class="section">
<h3><a name="a1_Get_some_Data_to_Sort"></a>1 Get some Data to Sort</h3>
<p>A nicely prepared download can be found at <a class="externalLink" href="http://pizzachili.dcc.uchile.cl/texts/nlang">pizzachili</a></p></div>
<div class="section">
<h3><a name="a2_Parse_your_Data"></a>2 Parse your Data</h3>
<p>The next step is to transform the downloaded text file to a file of ByteStorables (CBStrings in this case).</p>

<div class="source">
<div class="source">
<pre>public static void parse() throws Exception{
  Pattern p = Pattern.compile(&quot;[\\s|\\p{Punct}]+&quot;);
  InputStream is = new GZIPInputStream(new FileInputStream(&quot;/tmp/english.1024MB.gz&quot;));
  Scanner s = new Scanner(is);
  s.useDelimiter(p);
  CBString tmp;
  StorableOutputStream sos = new StorableOutputStream(new FileOutputStream(&quot;/tmp/english.1024MB.bs&quot;));
  int i = 0;
  while(s.hasNext()){
    String n = s.next();
    if(n.length() &gt; 1){
      tmp = new CBString(n);
      sos.write(tmp);
      i++;
    }
    if(i % 1000000 == 0)
      System.out.println(i);
  }
  sos.flush();
}
</pre></div></div>
<p>We use the Scanner class to extract all words form the file (omitting any words that has a length less than 2) and store them in a new file containing CBStrings. Later we will show a way of removing this step</p></div>
<div class="section">
<h3><a name="a3_Sort_Data"></a>3 Sort Data</h3>
<p>The final step is to sort the words and stored them in a new file</p>

<div class="source">
<div class="source">
<pre>public static void sSort() throws Exception {
  long l = System.currentTimeMillis();
  EDiscBasedSort&lt;String,CBString&gt; edb = new EDiscBasedSort &lt;&gt;(new CBString(), &quot;/tmp&quot;);
  edb.sort(&quot;/tmp/english.1024MB.bs&quot;, &quot;/tmp/english-sorted.bs&quot;, 1024*1024*160);
  System.out.println(&quot;esort took: &quot;+ (System.currentTimeMillis() - l) + &quot;ms&quot;);
}
</pre></div></div>
<p>A couple of things to note. When instantiating the EDiscBasedSort you need to provide a ByteComparable template to be used in the sorting step. Also in the actual sort you need to provide a size of the in-memory buffer that will be used for storing the ByteStorables to sort in each run. That buffer will be the basic memory footprint for the sort (with an additional array of integers holding positions in the buffer)</p></div>
<div class="section">
<h3><a name="a4_Combined_Parsing_and_Sorting"></a>4 Combined Parsing and Sorting</h3>
<p>In many cases it does not make sense to store an intermediate file (Step 2 above) but rather directly sort your input file. This can be done in many different ways. The core library contains a special InputStream that takes as input a Scanner and emits ByteStorables. So if we wanted to combine step 2 and 3 above we could do the following:</p>

<div class="source">
<div class="source">
<pre>public static void parseAndSort() throws Exception {
  Pattern p = Pattern.compile(&quot;[\\s|\\p{Punct}]+&quot;);
  InputStream is = new GZIPInputStream(new FileInputStream(&quot;/tmp/english.1024MB.gz&quot;));
  Scanner s = new Scanner(is);
  s.useDelimiter(p);
  BufferedOutputStream os = new BufferedOutputStream(new FileOutputStream(&quot;/tmp/english-sorted-1.bs&quot;),1024*1024);
  EDiscBasedSort &lt;String, CBString&gt; edb = new EDiscBasedSort &lt;&gt;(new CBString(), &quot;/tmp&quot;);
  edb.sort(new ScannerInputStream(s,1), os, 1024*1024*160);
  os.close();
}
</pre></div></div>
<p>As you can see the code is very similar with the difference that we now sort an ScannerInputStream and outputs an OutputStream. Doing this way will reduce the need of creating a file of ByteStorables first</p></div>
<div class="section">
<h3><a name="a5_Verifying"></a>5 Verifying</h3>
<p>A simple way to verify the output is to iterate through it is to use a <i>StorableInputStream</i> to read the sorted file and make sure no BStorable is smaller than the previous one</p>

<div class="source">
<div class="source">
<pre>public static void verify() throws Exception {
    StorableInputStream&lt;String, CBString&gt; sis = new StorableInputStream &lt;&gt;(new FileInputStream(&quot;/tmp/english-sorted.bs&quot;), new CBString());
    CBString prev = sis.next();
    CBString next = null;
    while((next = sis.next()) != null){
      if(prev.compareTo(next) &gt; 0){
        System.out.println(&quot;previous word greater than next &quot;+prev+&quot; &quot;+next);
      }
      prev = next;
    }
  }
</pre></div></div></div></div>
                  </div>
            </div>
          </div>

    <hr/>

    <footer>
            <div class="container-fluid">
              <div class="row span12">Copyright &copy;                   2015.
          All Rights Reserved.      
                    
      </div>

        
        
                </div>
    </footer>
  </body>
</html>
