<!DOCTYPE html>
<!--
 | Generated by Apache Maven Doxia at 2015-12-01
 | Rendered using Apache Maven Fluido Skin 1.3.0
-->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="Date-Revision-yyyymmdd" content="20151201" />
    <meta http-equiv="Content-Language" content="en" />
    <title>Mellowtech Core &#x2013; Overview</title>
    <link rel="stylesheet" href="./css/apache-maven-fluido-1.3.0.min.css" />
    <link rel="stylesheet" href="./css/site.css" />
    <link rel="stylesheet" href="./css/print.css" media="print" />

      
    <script type="text/javascript" src="./js/apache-maven-fluido-1.3.0.min.js"></script>

    
            </head>
        <body class="topBarDisabled">
          
        
    
        <div class="container-fluid">
          <div id="banner">
        <div class="pull-left">
                                    <a href="http://www.mellowtech.org/projects/core" id="bannerLeft">
                <h2>Mellowtech Core</h2>
                </a>
                      </div>
        <div class="pull-right">  </div>
        <div class="clear"><hr/></div>
      </div>

      <div id="breadcrumbs">
        <ul class="breadcrumb">
                
                    
                  <li id="publishDate">Last Published: 2015-12-01</li>
                  <li class="divider">|</li> <li id="projectVersion">Version: 3.0.3</li>
                      
                
                    
      
                            </ul>
      </div>

            
      <div class="row-fluid">
        <div id="leftColumn" class="span3">
          <div class="well sidebar-nav">
                
                    
                <ul class="nav nav-list">
                    <li class="nav-header">Overview</li>
                                
      <li>
    
                          <a href="index.html" title="introduction">
          <i class="none"></i>
        introduction</a>
            </li>
                  
      <li class="active">
    
            <a href="#"><i class="none"></i>byte storables</a>
          </li>
                  
      <li>
    
                          <a href="IO.html" title="IO">
          <i class="none"></i>
        IO</a>
            </li>
                  
      <li>
    
                          <a href="sorting.html" title="sorting">
          <i class="none"></i>
        sorting</a>
            </li>
                  
      <li>
    
                          <a href="collections.html" title="collections">
          <i class="none"></i>
        collections</a>
            </li>
                              <li class="nav-header">Project Documentation</li>
                                                                                                    
      <li>
    
                          <a href="project-info.html" title="Project Information">
          <i class="icon-chevron-right"></i>
        Project Information</a>
                  </li>
                                                                                                        
      <li>
    
                          <a href="project-reports.html" title="Project Reports">
          <i class="icon-chevron-right"></i>
        Project Reports</a>
                  </li>
            </ul>
                
                    
                
          <hr class="divider" />

           <div id="poweredBy">
                            <div class="clear"></div>
                            <div class="clear"></div>
                            <div class="clear"></div>
                             <a href="http://maven.apache.org/" title="Built by Maven" class="poweredBy">
        <img class="builtBy" alt="Built by Maven" src="./images/logos/maven-feather.png" />
      </a>
                  </div>
          </div>
        </div>
        
                
        <div id="bodyColumn"  class="span9" >
                                  
            <h1>Overview</h1>
<p>As was explained in the introduction Mellowtech Core is basically an API for supporting the developer in situations when in memory is not enough, e.g. objects needs to have a byte based representation.</p>
<p>In Java this is typically achieved with the Serialization API so why did we create an alternative? First and foremost, it was because of speed and to force a programmer to implement the necessary methods. Second, to a large extend Mellowtech Core works directly on ByteBuffers and the normal Serialization API does not have in-built support for that. Finally, we also wanted a way of comparing objects on a byte level, again something that the Serialization API does not support.</p>
<p>Today there are very good alternatives to the in-built Serialization API, such as, Google&#x2019;s Protobuf protocol. We are looking into how Mellowtech Core can support that.</p>
<p>Before we go on you should note that you would typically not have to create your own BStorable objects since the API comes with a lot of wrappers for common data types</p>
<div class="section">
<h2><a name="Using_Built_in_BStorables"></a>Using Built in BStorables</h2>
<p>The library comes with a set of built in BStorable types to handle most situations that you would need when serializing objects. The primitive types are:</p>

<ul>
  
<li>CBBoolean - stores a boolean</li>
  
<li>CBByte - stores a Byte</li>
  
<li>CBChar - stores a Character</li>
  
<li>CBShort - stores a short</li>
  
<li>CBInt - stores an int</li>
  
<li>CBLong - stores a long</li>
  
<li>CBFloat - stores a float</li>
  
<li>CBDouble - stores a double</li>
  
<li>CBString - stores a String</li>
  
<li>CBByteArray - stores a byte[]</li>
</ul>
<p>In addition to the primitive types you also have the following built ins</p>

<ul>
  
<li>CBList - implements the List Interface</li>
  
<li>CBMap - implements the map Interface</li>
  
<li>CBSortedMap - implements the map Interface</li>
  
<li>CBPrimitiveObject - can hold any of the above</li>
  
<li>CBRecord - base class for building complex types</li>
  
<li>AutoRecord - interface for building complex types</li>
</ul>
<p>In the first example we simply use the API to serialize an integer and read it back again.</p>

<div class="source">
<div class="source">
<pre>  public static void serialize(){
    CBInt firstInt = new CBInt(1);
    ByteBuffer bb = firstInt.to();
    CBInt secondInt = firstInt.from(bb);
    System.out.println(firstInt.get()+&quot; &quot;+secondInt.get());
  }
</pre></div></div>
<p>In the second example (below) we are using the CBMixedList to store a list of primitive BStorables.</p>

<div class="source">
<div class="source">
<pre> public static void list(){
    CBMixedList list = new CBMixedList();
    list.add(1);
    list.add(&quot;a string&quot;);
    list.add(new Long(100));
    list.add(true);

    ByteBuffer bb = list.to();
    list.clear();

    //don't create a new object
    bb.flip();
    list = list.from(bb);
    Integer first = (Integer) list.get(0);
    String second = (String) list.get(1);
    Long third = (Long) list.get(2);
    Boolean forth = (Boolean) list.get(3);
    System.out.println(first+&quot; &quot;+second+&quot; &quot;+third+&quot; &quot;+forth);
  }
</pre></div></div>
<p>It is easy to see how you can use BStorables as a way of doing deep copies</p>

<div class="source">
<div class="source">
<pre>ByteBuffer bb = BStorable.to();
bb.flip();
BStorable.fromBytes(bb)
</pre></div></div>
<p>This creates a true copy of your object. Since this is a common function it is also directly implemented in BStorable as</p>

<div class="source">
<div class="source">
<pre>BStorable copy = BStorable.deepCopy();
</pre></div></div></div>
<div class="section">
<h2><a name="Creating_BStorables"></a>Creating BStorables</h2>
<p>In many situations using the in-built BStorables are enough. However, if you need a more complex structure you will have to implement it. Again, this is the difference from e.g. java.io.Serializable. It is a little bit more work but it typically offers better performance. <i>BStorable</i> contains a lot of methods to assist the developer. At a minimum you are required to implement four methods and the empty constructor in your subclass.</p>
<div class="section">
<h3><a name="Subclassing_BStorable"></a>Subclassing BStorable</h3>
<p>Lets implement a BStorable that contains an integer and a string value</p>

<div class="source">
<div class="source">
<pre>public class Container1 extends BStorable &lt;Container1, Container1&gt; {

  private CBInt f1 = new CBInt();
  private CBString f2 = new CBString();

  public Container1(){;}

  public Container1(Integer field1, String field2){
    f1.set(field1);
    f2.set(field2);
  }

  @Override
  public Container1 from(ByteBuffer bb) {
    Container1 toRet = doNew ? new Container1();
    CBUtil.getSize(bb, false);
    toRet.f1 = toRet.f1.from(bb); //no need to create a new object
    toRet.f2 ) toRet.f1.from(bb); //no need to create a new object
    return toRet;
  }

  @Override
  public void to(ByteBuffer bb) {
    CBUtil.putSize(f1.byteSize()+f2.byteSize(), bb, false);
    f1.toBytes(bb);
    f2.toBytes(bb);
  }

  @Override
  public int byteSize() {
    return CBUtil.byteSize(f1.byteSize()+f2.byteSize(), false);
  }

  @Override
  public int byteSize(ByteBuffer bb) {
    return CBUtil.peekSize(bb, false);
  }
}
</pre></div></div>
<p>Later you can simply use Container1 as any of the predefined <i>ByteStorables</i></p>

<div class="source">
<div class="source">
<pre>  public static void testContainer1(){
    Container1 c1 = new Container1(10,&quot;ten&quot;);
    Container1 c2 = c1.deepCopy();
    System.out.println(&quot;testContainer1: &quot;+c2.f1+&quot; &quot;+c2.f2);
  }
</pre></div></div>
<p>A couple of important things to note when you create your own BStorables</p>

<ol style="list-style-type: decimal">
  
<li>
<p>You have to be able to determine the byte size within the first 4 bytes of the serialized object (that is why we include a size indicator</p></li>
  
<li>
<p>When calculating the byteSize don&#x2019;t forget to include any bytes that a size indicator would occupy</p></li>
  
<li>
<p>When reading the byteSize from a ByteBuffer your BStorable should not change the position in the ByteBuffer (that is why we used the utility function &lt;CBUtil.peekSize&gt;</p></li>
  
<li>
<p>BStorables should implement the empty constructor</p></li>
</ol></div>
<div class="section">
<h3><a name="Using_CBAuto"></a>Using CBAuto</h3>
<p>As an alternative to the above pattern where you implment the to/from bytes yourself you can use a CBAuto or CBRecord to simplify things. The first, CBAuto is the simplest but it will not allow you to separate the BStorable from the data you want to encapsulate. For both CBAuto and CBRecord the only caveat is that they will only support built in types (string, int, double, etc.)</p>

<div class="source">
<div class="source">
<pre>public class Container2 extends CBAuto &lt;Container2&gt; {

  @BSField(2) private Integer f1;
  @BSField(1) private String f2;

  public Container2(){
    super();
  }

  public Container2(Integer field1, String field2){
    this();
    this.f1 = field1;
    this.f2 = field2;
  } 
}
</pre></div></div></div>
<div class="section">
<h3><a name="Using_CBRecord_and_AutoRecord"></a>Using CBRecord and AutoRecord</h3>
<p>So similar to CBAuto the CBRecord simplifies things for you and it has the added benefit of separating your model (AutoRecord) from the BStorable implementation</p>

<div class="source">
<div class="source">
<pre>public class Container3 extends CBRecord &lt;Container3.Record, Container3&gt; {

  static class Record implements AutoRecord {
	  @BSField(2) public Integer f1;
	  @BSField(1) public String f2;
  }

  @Override
  protected Record newA() {
	return new Record();
  }

}
</pre></div></div>
<p>The idea with the CBRecord/AutoRecord pattern is to keep a clean separation of the BStorable (CBRecord) and the object (AutoRecord) it wraps. In other words the actual data record is a regular java object without any notion of BStorables. There are a couple of things to be aware of when using this pattern</p>

<ul>
  
<li>your wrapping CBRecord has to implement the newT function</li>
  
<li>your wrapping CBRecord has to call the empty constructor of super - if it implements it&#x2019;s own constructors</li>
</ul></div></div>
<div class="section">
<h2><a name="Comparing_With_BComparable"></a>Comparing With BComparable</h2>
<p>The original (and still) main purpose of the Mellowtech Core library was to offer functionality to sort and store objects on disc. In order to do this we have to be able to compare objects. In many situations the following would be sufficient</p>

<div class="source">
<div class="source">
<pre>new CBString(&quot;string&quot;).get().equals(&quot;string&quot;)
</pre></div></div>
<p>That is, you do your comparison on an object level. However, if you many million objects that have been serialized this scheme might impact performance quite a bit if you constantly have to create objects when doing comparisons.</p>
<p><i>BComparable</i> allows do do object comparison on a byte level. All in-built BStorables (except from CBMixedList) are also BComparables.</p>

<div class="source">
<div class="source">
<pre>public static void compareStrings(){
  ByteBuffer str1 = new CBString(&quot;a string&quot;).to();
	ByteBuffer str2 = new CBString(&quot;a string&quot;).to();
	System.out.println(new CBString().byteCompare(0, str1, 0, str2));
}
</pre></div></div>
<p>In the above example we compare two string on a byte level that are stored in 2 different ByteBuffers.</p>
<p>A slightly more involved use case of how to use the BComparable pattern would be two compare objects that are stored in the same ByteBuffer. An example of this could look something like this</p>

<div class="source">
<div class="source">
<pre>public static void compareInSameBuffer(){
  CBString str1 = new CBString(&quot;a string 1&quot;);
  CBString str2 = new CBString(&quot;a string&quot;);
  ByteBuffer bb = ByteBuffer.wrap(new byte[str1.byteSize()+str2.byteSize()]);
  str1.to(bb);
  str2.to(bb);
  System.out.println(new CBString().byteCompare(0, str1.byteSize(), bb));
}
</pre></div></div></div>
                  </div>
            </div>
          </div>

    <hr/>

    <footer>
            <div class="container-fluid">
              <div class="row span12">Copyright &copy;                   2015.
          All Rights Reserved.      
                    
      </div>

        
        
                </div>
    </footer>
  </body>
</html>
